name: Auto Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip release] or [no release]
    if: "!contains(github.event.head_commit.message, '[skip release]') && !contains(github.event.head_commit.message, '[no release]')"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tags
          fetch-tags: true

      - name: Determine version bump
        id: bump
        run: |
          # Get commit message first line
          MSG=$(echo "${{ github.event.head_commit.message }}" | head -1)

          # Determine bump type from conventional commit prefix
          if echo "$MSG" | grep -qE "^feat(\(.+\))?!:|^fix(\(.+\))?!:|^refactor(\(.+\))?!:|BREAKING CHANGE"; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif echo "$MSG" | grep -qE "^feat(\(.+\))?:"; then
            echo "type=minor" >> $GITHUB_OUTPUT
          elif echo "$MSG" | grep -qE "^fix(\(.+\))?:|^perf(\(.+\))?:|^refactor(\(.+\))?:"; then
            echo "type=patch" >> $GITHUB_OUTPUT
          else
            # Non-releasable commits (docs, test, chore, style, ci)
            echo "type=skip" >> $GITHUB_OUTPUT
          fi

      - name: Calculate next version
        id: version
        if: steps.bump.outputs.type != 'skip'
        run: |
          # Get latest tag
          LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST"

          # Parse version components
          VERSION=${LATEST#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Bump appropriate component
          case "${{ steps.bump.outputs.type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEXT="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Next version: $NEXT"
          echo "version=$NEXT" >> $GITHUB_OUTPUT

      - name: Create and push tag
        if: steps.bump.outputs.type != 'skip'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag with commit message
          MSG=$(echo "${{ github.event.head_commit.message }}" | head -1)
          git tag -a "${{ steps.version.outputs.version }}" -m "$MSG"
          git push origin "${{ steps.version.outputs.version }}"

          echo "Created tag ${{ steps.version.outputs.version }}"
